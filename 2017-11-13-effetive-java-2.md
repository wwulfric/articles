---
title: Effective-Java-åˆ›å»ºå’Œé”€æ¯å¯¹è±¡
date: 2017-11-13 20:08
categories: [æŠ€æœ¯]
tags: [java, effective java]
---

Effective Java[EJ] çš„ç¬¬äºŒç« è®²çš„æ˜¯åˆ›å»ºå’Œé”€æ¯å¯¹è±¡ï¼šåœ¨ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦åˆ›å»ºå¯¹è±¡ï¼Œæ€æ ·åˆ›å»ºï¼›åœ¨ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦é¿å…åˆ›å»ºå¯¹è±¡ï¼Œæ€æ ·é¿å…ï¼›å¦‚ä½•æŒ‰ç…§æ—¢å®šé¡ºåºé”€æ¯å¯¹è±¡ï¼Œå¦‚ä½•åœ¨é”€æ¯å¯¹è±¡å‰æ­£ç¡®æ¸…ç†ç°åœºã€‚

## ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•è€Œä¸æ˜¯æ„é€ å™¨ {#Item1}

åˆ›å»ºå¯¹è±¡çš„æœ€åŸºç¡€æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯é€šè¿‡æ„é€ å‡½æ•° new å‡ºæ¥ã€‚ä½†åœ¨å®é™…çš„å¤æ‚ä¸šåŠ¡ç¯å¢ƒä¸­ï¼Œå¾€å¾€æ˜¾å¾—å¤ªç®€å•ï¼Œä¸èƒ½å¾ˆå¥½çš„æ»¡è¶³å„ç§ä¸šåŠ¡éœ€æ±‚ï¼Œè€Œä¸”å¾ˆæœ‰å¯èƒ½ä½¿ä»£ç å˜å¾—æ··ä¹±ã€‚

ä½ å¯ä»¥è€ƒè™‘ä¸ºä½ çš„ç±»æä¾›ä¸€ä¸ªé™æ€å·¥å‚æ–¹æ³•ã€‚é™æ€å·¥å‚æ–¹æ³•æ˜¯ä¸€ä¸ªè¿”å›ç±»çš„ç¤ºä¾‹çš„é™æ€æ–¹æ³•ï¼Œå¦‚ï¼š

```java
public static Boolean valueOf(boolean b) {
    return b ? Boolean.TRUE : Boolean.FALSE;
}
```

é€šè¿‡é™æ€å·¥å‚æ–¹æ³•è·å–å®ä¾‹æ‹¥æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- é™æ€å·¥å‚æ–¹æ³•å¯ä»¥æ ¹æ®æ–¹æ³•åè¡¨æ˜è‡ªå·±çš„ä½œç”¨ï¼Œæ¯”å¦‚ valueOf è¡¨ç¤ºè·å–å€¼ï¼ŒnewInstance è¡¨ç¤ºåˆ›å»ºæ–°å®ä¾‹ï¼ŒgetInstance ä¸€èˆ¬æ„å‘³ç€æ‹¿åˆ°ä¸€ä¸ªé‡ç”¨çš„å®ä¾‹ã€‚å¦‚æœä¸€ä¸ªç±»éœ€è¦æä¾›ä¸åŒçš„å®ä¾‹ï¼Œé™æ€å·¥å‚æ–¹æ³•å¯ä»¥å¾ˆæ¸…æ™°çš„è¡¨æ˜è‡ªå·±ï¼Œè€Œæ„é€ å™¨ç”±äºæ–¹æ³•åå¿…é¡»å’Œç±»åä¸€è‡´ï¼Œå®¹æ˜“è®©äººæ„Ÿåˆ°æ··ä¹±ï¼›
- é™æ€å·¥å‚æ–¹æ³•åœ¨è°ƒç”¨æ—¶ä¸ä¸€å®šä¼šåˆ›å»ºå¯¹è±¡ï¼Œæ¯”å¦‚ Boolean.valueOf å°±ä¸ä¼šåˆ›å»ºå¯¹è±¡ï¼›
- æ„é€ å™¨ä¼šè¿”å›ä¸€ä¸ªç¡®å®šçš„ç±»å‹ï¼ˆå½“å‰ç±»ï¼‰ï¼Œè€Œé™æ€å·¥å‚æ–¹æ³•å¯ä»¥è¿”å› subtypeï¼ˆå­ç±»ï¼Œæ¥å£ç±»ï¼‰ï¼Œè¿™åœ¨ java.util.Collections ä¸­ç”¨çš„éå¸¸å¤šï¼›

```java
public static Map getInstance();
// è¿™ä¸ªæ¥å£å¯ä»¥è¿”å›æ‰€æœ‰å®ç°äº† Map çš„æ¥å£çš„ç±»çš„å®ä¾‹

public static AbstractMap getInstance();
// è¿™ä¸ªæ¥å£å¯ä»¥è¿”å›æ‰€æœ‰ç»§æ‰¿äº† AbstractMap çš„ç±»çš„å®ä¾‹
```

- è®©å¼€å‘è€…æ›´å…³æ³¨è¿”å›å¯¹è±¡çš„æ¥å£è€Œä¸æ˜¯å…·ä½“çš„å®ç°ç±»ï¼›
- æ–¹ä¾¿ç»´æŠ¤ã€‚æ¯”å¦‚ä¸€ä¸ªæ¥å£è¿”å› EnumSetï¼Œåœ¨å®ç°ä¸Šå¯ä»¥è¿”å›å„ç§ EnumSet çš„å­ç±»å‹ï¼Œå‡çº§ä¹‹åä¹Ÿå¯ä»¥æ›´æ”¹è¿”å›çš„ç±»å‹ã€‚

ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯æœåŠ¡æä¾›æ¡†æ¶ï¼ˆTODOï¼‰ã€‚

ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•çš„åŠ£åŠ¿ï¼š

- åªæœ‰é™æ€å·¥å‚æ–¹æ³•çš„ç±»ï¼Œæ— æ³•åˆ›å»ºå­ç±»æ¥ç»§æ‰¿ï¼›
- ä¸èƒ½è®©äººä¸€çœ¼çœ‹å‡ºæ¥æ˜¯é‡è¦çš„åˆ›å»ºå¯¹è±¡çš„æ–¹æ³•ï¼ˆå’Œæ„é€ å‡½æ•°ç›¸æ¯”ï¼‰ï¼Œåªèƒ½åœ¨æ³¨é‡Šä¸­å†™æ˜ ã€‚

å¸¸ç”¨çš„é™æ€å·¥å‚æ–¹æ³•çš„åå­—æœ‰ï¼švalueOf, of,newInstance, getInstance, getType, newType ç­‰ã€‚

å½“ä½ ç¼–å†™ç±»çš„æ—¶å€™ï¼Œè¯·å…ˆè€ƒè™‘ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•ï¼Œå¦‚æœç¡®å®šä¸éœ€è¦ï¼Œå†ä½¿ç”¨æ„é€ å™¨ã€‚

## æ„é€ å‡½æ•°å‚æ•°è¿‡å¤šçš„æ—¶å€™å¯ä»¥è€ƒè™‘ Builder {#Item2}

é™æ€å·¥å‚æ–¹æ³•å’Œæ„é€ å™¨æœ‰ä¸€ä¸ªå…±åŒçš„å±€é™ï¼šä¸èƒ½å¾ˆå¥½çš„æ‰©å±•åˆ°å¤§é‡çš„å¯é€‰å‚æ•°ã€‚ä¹¦ä¸­ç»™å‡ºäº†è¿™æ ·ä¸€ä¸ªä¾‹å­ï¼š

```java
// Telescoping constructor pattern - does not scale well!
public class NutritionFacts {
  // ... field å®šä¹‰
  public NutritionFacts(int servingSize, int servings);
  public NutritionFacts(int servingSize, int servings, int calories);
  public NutritionFacts(int servingSize, int servings, int calories, int fat);
  public NutritionFacts(int servingSize, int servings, int calories, int fat, int sodium);
  public NutritionFacts(int servingSize, int servings, int calories, int fat, int sodium, int carbohydrate);
}
```

è¿™æ ·çš„æ„é€ å‡½æ•°æƒ³å¿…åœ¨æ²¡æœ‰å……åˆ†ä¼˜åŒ–çš„ä»£ç ä¸­å¾ˆå¸¸è§ã€‚å®¢æˆ·ç«¯æƒ³è¦çš„å®ä¾‹å¯èƒ½æœ‰å„ç§æƒ…å†µçš„é»˜è®¤å€¼ï¼Œç±»å°±è¦ä¸ºå„ç§æƒ…å†µéƒ½æä¾›æ„é€ å™¨ï¼Œä»£ç æ˜¾å¾—éå¸¸è‡ƒè‚¿ï¼›å½“è·å–å®ä¾‹çš„æ—¶å€™ï¼Œå†—é•¿çš„å‚æ•°åˆ—è¡¨ä¹Ÿå¾ˆå®¹æ˜“å¯¼è‡´å‚æ•°å¡«å†™å‡ºé”™ã€‚é™æ€å·¥å‚æ–¹æ³•ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

JavaBean å¯ä»¥é¿å…è¿™ç§é—®é¢˜ã€‚JavaBean åœ¨ç°ä»£ java ä»£ç ä¸­åº”è¯¥è¯´ä½¿ç”¨çš„éå¸¸é¢‘ç¹äº†ï¼ˆåºåˆ—åŒ–ï¼Œå¯¹è±¡æŒä¹…åŒ–ç­‰ï¼‰ã€‚å®¢æˆ·ç«¯å…ˆ new ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œç„¶åè°ƒç”¨ setter æ–¹æ³•è®¾ç½®å±æ€§ã€‚JavaBean ä»£ç æ²¡é‚£ä¹ˆè‡ƒè‚¿äº†ï¼ŒåŒæ—¶ä¹Ÿä¸å®¹æ˜“å¡«é”™å‚æ•°ï¼Œä½†æ˜¯ä¸€æ ·æœ‰ç¼ºç‚¹ï¼š

- ä»£ç é•¿ï¼Œæ¯ä¸ªå‚æ•°éƒ½éœ€è¦æä¾› setter æ–¹æ³•ï¼›setter æ–¹æ³•é€šå¸¸è¿”å›å€¼æ˜¯ voidï¼Œè¿™æ„å‘³ç€å®¢æˆ·ç«¯ä»£ç åªèƒ½ä¸€è¡Œä¸€è¡Œ setï¼Œä¸èƒ½é“¾å¼è°ƒç”¨ï¼›
- JavaBean ä¾¿æ— æ³•å®ç°ä¸å¯å˜å¯¹è±¡ï¼Œå› ä¸ºéšæ—¶å¯ä»¥æ‰§è¡Œ setter æ–¹æ³•ï¼Œå¯¹è±¡çš„çŠ¶æ€ä¸å¯æ§ã€‚JavaBean ææœ‰å¯èƒ½å‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå¯¹å®¢æˆ·ç«¯æ¥è¯´ï¼Œå®ƒå¹¶ä¸çŸ¥é“è¿™ä¸ª JavaBean æ˜¯å¦å·²ç»å®Œæˆæ„å»ºï¼ˆä½ å¹¶ä¸çŸ¥é“æŸä¸ª setter æ˜¯å°šæœªæ‰§è¡Œè¿˜æ˜¯ä¸éœ€è¦æ‰§è¡Œï¼‰ï¼Œè¿™å¯¼è‡´è¯¥å¯¹è±¡æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚

Builder æ¨¡å¼å¯ä»¥å¾ˆå¥½çš„å…¼é¡¾å®‰å…¨å’Œä»£ç å¯è¯»æ€§ã€‚Builder æ˜¯ç›®æ ‡ç±»çš„é™æ€æˆå‘˜ç±»ï¼Œåœ¨ Builder ç±»ä¸­å¤„ç†å®é™…å‚æ•°çš„è®¾ç½®ã€‚å®¢æˆ·ç«¯é€šè¿‡ Builder ç±»è®¾ç½®å‚æ•°ï¼Œç„¶åç”±æ— å‚çš„ build æ–¹æ³•è·å–æ‰€éœ€çš„ä¸å¯å˜å¯¹è±¡ã€‚

```java
// Builder æ¨¡å¼
public class NutritionFacts {
    private final int servingSize;
    private final int servings;
    private final int calories;
    private final int fat;
    private final int sodium;
    private final int carbohydrate;

    public static class Builder {
        // å¿…éœ€å‚æ•°
        private final int servingSize;
        private final int servings;

        // å¯é€‰å‚æ•° - åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼
        private int calories     = 0;
        private int fat          = 0;
        private int sodium       = 0;
        private int carbohydrate = 0;

        public Builder(int servingSize, int servings) {
            this.servingSize = servingSize;
            this.servings    = servings;
        }

        public Builder calories(int val) 
            { calories = val;        return this; }
        public Builder fat(int val)
            { fat = val;             return this; }
        public Builder sodium(int val)
            { sodium = val;          return this; }
        public Builder carbohydrate(int val)
            { carbohydrate = val;    return this; }

        public NutritionFacts build() {
            return new NutritionFacts(this);
        }
    }

    private NutritionFacts(Builder builder) {
        servingSize  = builder.servingSize;
        servings     = builder.servings;
        calories     = builder.calories;
        fat          = builder.fat;
        sodium       = builder.sodium;
        carbohydrate = builder.carbohydrate;
    }
}
```

å¯è§ï¼ŒNutritionFacts æ˜¯ä¸å¯å˜çš„ï¼›Builder çš„ setter æ–¹æ³•è¿”å› thisï¼Œè¿™æ ·å¯ä»¥é“¾å¼è°ƒç”¨ setterï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```java
NutritionFacts cocaCola = new NutritionFacts.Builder(240, 8).calories(100).sodium(35).carbohydrate(27).build()
```

åŠ¨æ€è¯­è¨€å¦‚ Python å¯ä»¥é€šè¿‡å‚æ•°é»˜è®¤å€¼å®ç°ç±»ä¼¼æ•ˆæœï¼Œæ¯”å¦‚ï¼š

```python
def f(a=1, b=2, c=3):
  print(a,b,c)

f(c=1,a=3)
```

Builder æ¨¡å¼ä»£ç æ˜“ç¼–å†™ï¼Œæ˜“é˜…è¯»ï¼ŒåŒæ—¶åŒæ—¶å¯ä»¥å®ç°ä¸å¯å˜å¯¹è±¡ï¼Œå› æ­¤æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼š

- å‚æ•°å¯æ£€æŸ¥ï¼Œå¯ä»¥åœ¨ Builder çš„ builder ä¸­æ£€æŸ¥å‚æ•°æ˜¯å¦ç¬¦åˆçº¦æŸæ¡ä»¶ã€‚çº¦æŸæ¡ä»¶çš„æ£€æŸ¥åº”è¯¥åœ¨ object çš„ fields ä¸Šè€Œä¸æ˜¯ Builder çš„ fields ä¸Šï¼Œ å¦åˆ™è¿˜æ˜¯çº¦æŸæ¡ä»¶è¿˜æ˜¯æœ‰å¯èƒ½è¢«ç ´åã€‚è¯¦è§ Item 39ï¼ˆTODOï¼‰ï¼›
- å¯ä»¥æœ‰å¤šä¸ª varargsï¼ˆæ¯ä¸ª setter éƒ½å¯ä»¥ï¼‰ï¼Œéå¸¸çµæ´»ï¼›
- åˆ›å»ºå¯¹è±¡æ—¶å¯ä»¥è‡ªåŠ¨å¡«å…¥æŸäº›å­—æ®µï¼Œä¾‹å¦‚æ¯æ¬¡åˆ›å»ºå¯¹è±¡æ—¶è‡ªåŠ¨å¢åŠ åºåˆ—å·ï¼›
- é™æ€æŠ½è±¡å·¥å‚ï¼ˆTODOï¼‰ã€‚

å½“ç„¶ Builder æ¨¡å¼ä¹Ÿæœ‰è‡ªèº«çš„ç¼ºç‚¹ï¼š

- åˆ›å»º Builder å¯¼è‡´çš„æ½œåœ¨çš„æ€§èƒ½é—®é¢˜ï¼Œä¸€èˆ¬æ¥è¯´å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä½†åœ¨æŸäº›æ€§èƒ½æ•æ„Ÿçš„åœºåˆå°±å¿…é¡»è€ƒè™‘åˆ°è¿™ç§æŸè€—ï¼›
- å†™èµ·æ¥ç¨å¾®æœ‰ç‚¹éº»çƒ¦ï¼Œå› æ­¤åªé€‚ç”¨äºå‚æ•°å¾ˆå¤šï¼Œå®šåˆ¶åŒ–å¾ˆå¼ºçš„åœºæ™¯ï¼ˆè¦è€ƒè™‘åˆ°æœªæ¥çš„æƒ…å†µï¼Œä¸€ä¸ªç±»å¾ˆæœ‰å¯èƒ½æœ‰ç®€å•å˜å¾—å¤æ‚ï¼‰ã€‚

éšç€ä»£ç çš„ç§¯ç´¯å¯èƒ½æ—¢æœ‰æ„é€ å™¨ä¹Ÿæœ‰ Builderï¼Œè¿™ä½¿å¾—ä»£ç æ˜¾å¾—æ··ä¹±ä¸æ˜“æ§åˆ¶ï¼Œå› æ­¤æ¨èä¼˜å…ˆä½¿ç”¨ Builderã€‚

## ä½¿ç”¨ç§æœ‰æ„é€ å™¨æˆ–æšä¸¾ç±»å‹å¼ºåŒ–å•ä¾‹å±æ€§ {#Item3}

å•ä¾‹ä¹Ÿæ˜¯ä¸€ç§å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ï¼ŒSingleton é€šå¸¸è¢«ç”¨æ¥ä»£è¡¨é‚£äº›æœ¬è´¨ä¸Šå”¯ä¸€çš„ç³»ç»Ÿç»„ä»¶ï¼Œæ¯”å¦‚çª—å£ç®¡ç†å™¨æˆ–è€…æ–‡ä»¶ç³»ç»Ÿã€‚ä½† Singleton ä½¿å¾—æµ‹è¯•æ›´å›°éš¾ï¼šæ— æ³•ä½¿ç”¨ mock çš„æ›¿ä»£å®ç°ï¼Œé™¤éå®ç°äº†ä¸€ä¸ªå¯ä»¥çœ‹åšè¯¥ç±»å‹çš„æ¥å£ã€‚

å¸¸ç”¨çš„ä¸¤ä¸ªå®ç°å•ä¾‹æ–¹æ³•ï¼š

1. å®ä¾‹æˆå‘˜æ˜¯ä¸€ä¸ª final çš„å˜é‡

```java
// Singleton with public final field
public class Elvis {
    public static final
Elvis INSTANCE = new Elvis();
    private Elvis() { ... }
public void leaveTheBuilding() { ... }
}
```

2. é€šè¿‡ä¸€ä¸ªé™æ€å·¥å‚æ–¹æ³•è¿”å›

```java
// Singleton with static factory
public class Elvis {
    private static final
Elvis INSTANCE = new Elvis();
    private Elvis() { ... }
    public static Elvis getInstance() { return INSTANCE }
public void leaveTheBuilding() { ... }
}
```

éœ€è¦æ³¨æ„ï¼Œäº«æœ‰ç‰¹æƒçš„å®¢æˆ·ç«¯å¯ä»¥å€ŸåŠ© AccessibleObject.setAccessible æ–¹æ³•ï¼Œé€šè¿‡åå°„æœºåˆ¶ï¼ˆItem 53ï¼‰è°ƒç”¨ç§æœ‰æ„é€ å™¨ã€‚å¦‚æœéœ€è¦æŠµå¾¡è¿™ç§æ”»å‡»ï¼Œå¯ä»¥ä¿®æ”¹æ„é€ å™¨ï¼Œè®©å®ƒåœ¨è¢«è¦æ±‚åˆ›å»ºç¬¬äºŒä¸ªå®ä¾‹çš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸ã€‚

å¾—ç›Šäºç°ä»£ JVM çš„ä¼˜åŒ–ï¼ŒäºŒè€…æ€§èƒ½ä¸Šæ²¡å•¥åŒºåˆ«ï¼›å‰è€…ç®€å•ï¼Œä½†åè€…æ›´åŠ çµæ´»ï¼Œå¯ä»¥æ”¯æŒå…¨å±€å•ä¾‹ï¼Œçº¿ç¨‹å†…å•ä¾‹ç­‰ï¼›è€Œä¸”åœ¨æ³›å‹æ–¹é¢ä¹Ÿæ›´æœ‰ä¼˜åŠ¿ã€‚

å‰ä¸¤ç§å®ç°æœ‰è¿™ä¹ˆä¸€ä¸ªé—®é¢˜ï¼šå®¹æ˜“åœ¨åºåˆ—åŒ–çš„æ—¶å€™è¸©å‘ã€‚å› ä¸ºæ¯æ¬¡ååºåˆ—åŒ–éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ ä¸€ä¸ª readResolve æ–¹æ³•ï¼š

```java
// readResolve method to preserve sigleton property
private Object readResolve() {
    // Return the one true Elvis and let the garbage
collector
    // take care of the Elvis impersonator.
    return
INSTANCE;
}
```

ç°åœ¨æ›´æ¨èä½¿ç”¨æšä¸¾æ¥å®ç°å•ä¾‹ï¼Œå®ƒå’Œ public field æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯è‡ªå¸¦åºåˆ—åŒ–æ”¯æŒï¼Œå¯ä»¥é˜²èŒƒå¤æ‚çš„åºåˆ—åŒ–å’Œåå°„æ”»å‡»ã€‚å•å…ƒç´ çš„æšä¸¾ç±»å‹å·²ç»æˆä¸ºå®ç° Singleton çš„æœ€ä½³æ–¹æ³•ã€‚

```java
// Enum singleton - the prefered approach
public enum Elvis {
    INSTANCE;

    public void leaveTheBuilding() { ... }
}
```

## ä½¿ç”¨ç§æœ‰æ„é€ å™¨å¼ºåˆ¶ç¦æ­¢å®ä¾‹åŒ– {#Item4}

æœ‰äº›ç±»å°±æ˜¯éœ€è¦è®¾è®¡æˆä¸èƒ½å®ä¾‹åŒ–çš„ï¼Œæ¯”å¦‚ util å·¥å…·ç±»ï¼ŒMath ç±»ï¼Œå®ç°åŒä¸€æ¥å£çš„å¯¹è±¡çš„å·¥å‚æ–¹æ³•ç­‰ç­‰ã€‚å¯¹äºè¿™äº›ç±»ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªç§æœ‰çš„æ„é€ å™¨ï¼Œè¿™æ ·å°±ä¸èƒ½å®ä¾‹åŒ–äº†ã€‚

```java
// Noninstantiable utility class
public class UtilityClass {
    // Suppress default constructor for noninstantiability
    private UtilityClass() {
        throw new AssertionError();
    }
    ... // Remainder omitted
}
```

ç¼ºç‚¹æ˜¯è¿™ç§ç±»ä¹Ÿæ— æ³•ç»§æ‰¿äº†ã€‚

## é¿å…åˆ›å»ºä¸å¿…è¦çš„å¯¹è±¡ {#Item5}

å¦‚æœå¯¹è±¡å¯é‡ç”¨ï¼Œå°½é‡é‡ç”¨è€Œä¸æ˜¯æ¯æ¬¡éƒ½æ–°å»ºï¼Œè¿™æ ·èƒ½å¤ŸèŠ‚çœèµ„æºã€‚å¦‚æœå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œå®ƒå°±å§‹ç»ˆå¯ä»¥è¢«é‡ç”¨ã€‚


å¯¹äºåŒæ—¶æä¾›äº†é™æ€å·¥å‚æ–¹æ³•ï¼ˆ[Item 1](#Item1)ï¼‰å’Œæ„é€ å™¨çš„ä¸å¯å˜ç±»ï¼Œé€šå¸¸å¯ä»¥ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•è€Œä¸æ˜¯æ„é€ å™¨ï¼Œä»¥é¿å…åˆ›å»ºä¸å¿…è¦çš„å¯¹è±¡ã€‚

å¦‚æœä¸€ä¸ªå±æ€§åˆå§‹åŒ–ä¹‹åå°±ä¸å†å˜åŒ–ï¼Œå¹¶ä¸”ä¼šè¢«å¤šæ¬¡ä½¿ç”¨ï¼Œå®ƒåº”è¯¥è¢«å½“åšå¸¸é‡ï¼ˆstatic final fieldï¼‰ï¼Œå°½é‡ä¸è¦å½“åšå˜é‡ã€‚

æœ‰ä¸€ç§å®¹æ˜“å¿½ç•¥çš„ä¸å¿…è¦åˆ›å»ºå¯¹è±¡çš„åœºåˆï¼šåŸºæœ¬ç±»å‹çš„è‡ªåŠ¨è£…ç®±ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
// Hideously slow program! Can you spot the object creation?
public static void main(String[] args) {
    Long sum = 0;
    for (long i = 0; i <
            Integer.MAX_VALUE; i++) {
        sum += i;
    }
    System.out.println(sum);
}
```

ä¸Šé¢è¿™æ®µä»£ç å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯å¾ˆæ…¢ï¼Œå› ä¸º sum æ˜¯ Long ç±»å‹ï¼Œè€Œ i æ˜¯ long ç±»å‹ï¼Œæ‰§è¡Œ`sum += i`çš„æ—¶å€™ä¼šè‡ªåŠ¨ç»™ i è£…ç®± Longï¼Œç„¶åæ‰§è¡Œè®¡ç®—ã€‚å¯æƒ³è€ŒçŸ¥è‡ªåŠ¨è£…ç®±æ‰§è¡Œäº† Integer.MAX_VALUE æ¬¡ï¼Œä¹Ÿåˆ›å»ºäº† Integer.MAX_VALUE è¿™ä¹ˆå¤šä¸­é—´å¯¹è±¡ã€‚

è§£å†³æ–¹æ³•ï¼šå°†`Long sum = 0L`æ”¹æˆ`long sum = 0`å³å¯ï¼Œè¿™æ ·å°±ä¸å­˜åœ¨è‡ªåŠ¨è£…ç®±äº†ã€‚ä½†ä¸èƒ½å°†`long i = 0`æ”¹æˆ`Long i = 0L`ï¼Œå› ä¸º Long æ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨è¿›è¡ŒåŠ æ³•çš„æ—¶å€™ï¼Œäº‹å®ä¸Šæ˜¯æ¯æ¬¡éƒ½è¦åˆ›å»º Long å¯¹è±¡ï¼Œé€Ÿåº¦ä¾ç„¶ä¼šå¾ˆæ…¢ï¼Œä½† long æ²¡æœ‰å¯¹è±¡åˆ›å»ºï¼Œåªæ˜¯åŸºæœ¬ç±»å‹ï¼Œé€Ÿåº¦ä¼šå¥½å¾ˆå¤šã€‚

è¿™ä¸ªä¾‹å­è¡¨æ˜ï¼Œè¦ä¼˜å…ˆä½¿ç”¨åŸºæœ¬ç±»å‹è€Œä¸æ˜¯è£…ç®±åŸºæœ¬ç±»å‹ï¼Œè¦å½“å¿ƒæ— æ„è¯†çš„è‡ªåŠ¨è£…ç®±ã€‚

ä½†æ˜¯å®é™…ä½¿ç”¨ä¸­ææ€•è¿˜æ˜¯è£…ç®±ç±»å‹å¤šä¸€äº›ï¼Œæ¯•ç«Ÿæ³›å‹åªæ”¯æŒè£…ç®±ç±»å‹ä¸æ”¯æŒåŸºæœ¬ç±»å‹ã€‚ä¹¦ä¸­ä¹Ÿè¡¨ç¤ºï¼Œå°å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯æ˜¯å¾ˆè½»é‡çš„æ“ä½œï¼Œé€šè¿‡åˆ›å»ºå¯¹è±¡ä½¿å¾—ç¨‹åºç®€æ´ã€æ¸…æ™°ã€åŠŸèƒ½å¼ºå¤§ï¼Œè¿™æ˜¯ä¸€ä»¶å¥½äº‹ã€‚

åœ¨æå€¡ä½¿ç”¨ä¿æŠ¤æ€§æ‹·è´çš„æ—¶å€™ï¼Œå› ä¸ºé‡ç”¨å¯¹è±¡è¦ä»˜å‡ºçš„ä»£ä»·è¦è¿œè¿œå¤§äºå› åˆ›å»ºé‡å¤å¯¹è±¡è€Œä»˜å‡ºçš„ä»£ä»·ã€‚å¿…è¦æ—¶å¦‚æœæ²¡èƒ½å®æ–½ä¿æŠ¤æ€§æ‹·è´ï¼Œå°†ä¼šå¯¼è‡´æ½œåœ¨çš„é”™è¯¯å’Œå®‰å…¨æ¼æ´ï¼›è€Œä¸å¿…è¦çš„åˆ›å»ºå¯¹è±¡åˆ™åªä¼šå½±å“ç¨‹åºçš„é£æ ¼å’Œæ€§èƒ½ã€‚

## æ¶ˆé™¤è¿‡æœŸçš„å¯¹è±¡å¼•ç”¨ {#Item6}

Java ä¸èƒ½ä½¿ç”¨æŒ‡é’ˆï¼Œè¿‡æœŸçš„å¯¹è±¡ç”±ç³»ç»Ÿè‡ªåŠ¨å›æ”¶ï¼ˆGCï¼‰ã€‚ä½†æ˜¯å³ä½¿æœ‰ GCï¼Œä¹Ÿä¸èƒ½å®Œå…¨ä¸å…³å¿ƒå†…å­˜ç®¡ç†ï¼Œæœ¬èŠ‚è®²çš„å°±æ˜¯è¿™ç§æƒ…å†µã€‚

ä¹¦ä¸­çš„ Stack ç¤ºä¾‹è¡¨æ˜ï¼Œå¦‚æœæ²¡æœ‰åŠæ—¶æ¸…é™¤è¿‡æœŸå¼•ç”¨ï¼Œå°±å¯èƒ½å¯¼è‡´å‡ºç°å†…å­˜æ³„éœ²ã€‚ä¸€ä¸ªè¿‡æœŸå¼•ç”¨æ²¡æœ‰æ¸…é™¤çš„è¯ï¼Œè¯¥å¯¹è±¡æ‰€å¼•ç”¨çš„å…¶ä»–å¯¹è±¡ä¹Ÿä¸ä¼šè¢«æ¸…é™¤äº†ï¼Œéšç€è¿™ç§è¿‡æœŸå¼•ç”¨çš„ç§¯ç´¯ï¼Œå¯èƒ½ä¼šä½¿ç¨‹åºå‘ç”Ÿ OOM å´©æºƒã€‚

è§£å†³æ–¹æ³•å°±æ˜¯ null æ‰è¿‡æœŸçš„å¼•ç”¨ã€‚

ä½†æ˜¯ä¸åº”è¯¥å¯¹æ­¤è¿‡åˆ†å°å¿ƒï¼Œjvmçš„ GC æ•ˆç‡æ˜¯å¾ˆé«˜çš„ã€‚æ—¶åˆ»æé†’è‡ªå·±è¦æ¸…é™¤å¯¹è±¡å¼•ç”¨ä¸ä»…éº»çƒ¦ï¼Œè€Œä¸”ä¼šè®©ä»£ç æ··ä¹±ã€‚æ§åˆ¶å¥½å˜é‡çš„ä½œç”¨åŸŸï¼Œä¾èµ–æ­£å¸¸çš„ GC æ¥åšè¿™ä»¶äº‹æƒ…ã€‚

åœ¨ä¾‹å­ä¸­ï¼ŒStack è‡ªå·±ç®¡ç†å†…å­˜ï¼Œæ‰€ä»¥å°±å¯èƒ½å‡ºç°å†…å­˜ç®¡ç†ä¸å–„çš„é—®é¢˜ã€‚æ‰€ä»¥ï¼Œå½“éœ€è¦è‡ªå·±ç®¡ç†å†…å­˜æ—¶ï¼Œä¸€å®šè¦æ³¨æ„æ½œåœ¨çš„å†…å­˜æ³„éœ²é—®é¢˜ã€‚

## é¿å…ä½¿ç”¨ç»ˆç»“æ–¹æ³• {#Item7}

ç»ˆç»“æ–¹æ³•ï¼ˆfinalizerï¼‰é€šå¸¸æ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œä¹Ÿæ˜¯å¾ˆå±é™©çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸å¿…è¦çš„ï¼š

- finalizer æ˜¯ GC è°ƒç”¨çš„ï¼ŒGC è°ƒç”¨æ—¶é—´ä¸å¯é¢„æµ‹
- æ€§èƒ½å˜å·®

èµ„æºå›æ”¶åº”è¯¥æ˜¾å¼ä½¿ç”¨ try finallyã€‚

finalizer ä¹Ÿæœ‰å¯ä»¥ä½¿ç”¨çš„åœºåˆï¼Œä½†éƒ½æ¯”è¾ƒåé—¨ï¼Œè¿˜æ˜¯ä¸è¦ç”¨äº†ï¼ŒçœŸæ­£éœ€è¦çš„æ—¶å€™è‡ªç„¶ä¼šæƒ³èµ·æ¥æœ‰è¿™ä¸ªä¸œè¥¿çš„ã€‚